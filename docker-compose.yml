#version: '3.8'

#   By Rodrigo Monteiro Junior (TsukiGva2)
#   qua 28 ago 2024 12:41:57 -03
#
#      Please ensure *ALL* _services_ contain the property
#      `restart: always`, as they run in an embedded
#      environment we cannot control.
#
#      Another useful convention is naming containers
#      like `monotempo_X` where X is the name of the
#      image being built.
#
#   Version 0.2
#     Docker compose file for setting up
#      - MySql.............................(mysql:8.0)
#      - ...
#      - ...
#      - ...
#      - ...
#      - PÃ¡gina Hotspot....................(php) <-- added
#
#      And PhpMyAdmin for debugging database stuff
#
#
#      Reorganized priorities:
#
#      - TODO: Unhardcode values everywhere, use a .env instead;
#
#     < Low Priority >
#
#      - TODO: bump mysql to latest;
#      - TODO: remove PhpMyAdmin? [Y/n];
#      - TODO: remove rabbitmq-management plugin? [Y/n].
#      - TODO: improve security at mysql and rabbitmq containers;
#
#   Version 0.1
#     Docker compose file for setting up
#      - MySql.............................(mysql:8.0)
#      - Reader............................(MyReader)
#      - RabbitMQ Message broker for comms.(rabbitmq)
#      - Auto-Update functionality.........(Receba)
#      - Sending collected data to the API.(Envio)
#
#      And PhpMyAdmin for debugging database stuff
#
#      - TODO: Unhardcode values everywhere, use a .env instead;
#      - TODO: bump mysql to latest;
#      - TODO: improve security at mysql and rabbitmq containers;
#      - TODO: remove PhpMyAdmin? [Y/n];
#      - TODO: remove rabbitmq-management plugin? [Y/n].
#
#      < Low priority >
#
#      - TODO: Use a script (or just the fucking .env) to set
#              the reader type and model name easily.

services:
  db:
    # TODO: bump mysql to latest?
    image: mysql:8.0
    container_name: monotempo_mysql
    restart: always
    environment:
      # XXX: security? Never heard of it
      MYSQL_ROOT_PASSWORD: mytempo_root1
      MYSQL_DATABASE: mytempo
      MYSQL_USER: mytempo_user
      MYSQL_PASSWORD: mytempo1
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/mytempo.sql:/docker-entrypoint-initdb.d/mytempo.sql
      - ./mysql/my.cnf:/etc/my.cnf
      - db_data:/var/lib/mysql

  # FIXME: remove this, it's just for debugging
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: monotempo_phpmyadmin
    restart: always
    environment:
      PMA_HOST: db
      PMA_USER: mytempo_user
      PMA_PASSWORD: mytempo1
    ports:
      - "8082:80"

  rabbitmq:
    # FIXME: management is also a debug thing, get rid of it
    image: rabbitmq:3-management
    container_name: monotempo_rabbitmq
    restart: always

    ports:
      - "5672:5672"
      - "15672:15672"

    environment:
      # XXX: less of a security concern, but please set better credentials
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  php:
    container_name: monotempo_pagina
    restart: always
    build:
      context: Php

    depends_on:
      - db
      - rabbitmq

    volumes:
      - ./network:/host-network

    environment:
      MYSQL_DB: mytempo
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_USER: mytempo_user
      MYSQL_PASS: mytempo1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      RABBITMQ_MGMT_PORT: 15672
    ports:
      - 80:80

  receba:
    container_name: monotempo_receba
    restart: always
    build:
      context: Receba

    depends_on:
      - db

    environment:
      MYSQL_DB: mytempo
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_USER: mytempo_user
      MYSQL_PASS: mytempo1
      MYTEMPO_EQUIP: "PORTAL LEITOR RFIDMY502" # TODO: This has to be set manually
      MYTEMPO_API_URL: "api.v2.mytempo.esp.br"

  envio:
    container_name: monotempo_envio
    restart: always
    build:
      context: Envio

    depends_on:
      - rabbitmq
      - db

    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      MYSQL_DB: mytempo
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_USER: mytempo_user
      MYSQL_PASS: mytempo1
      MYTEMPO_API_URL: "api.v2.mytempo.esp.br"

  analytics:
    container_name: monotempo_analytics
    restart: always
    build:
      context: Analytics

    depends_on:
      - rabbitmq
      - db

    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      MYSQL_DB: mytempo
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_USER: mytempo_user
      MYSQL_PASS: mytempo1

   aa2:
    container_name: monotempo_aa2
    restart: always
    privileged: true
    build:
      context: AA2

    depends_on:
      - rabbitmq

    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"
      - "/dev/sdb:/dev/sdb"

    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      READER_IP: "192.168.1.200" # TODO: This has to be set manually 
      MYTEMPO_API_URL: "api.v2.mytempo.esp.br"

  myreader:
    container_name: monotempo_myreader
    restart: always
    build:
      context: MyReader
    logging:
      driver: none

    depends_on:
      - rabbitmq

    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      MYTEMPO_READER_TYPE: chafon # TODO: This has to be set manually
      MYTEMPO_READER: "PORTAL LEITOR RFIDMY502" # TODO: This has to be set manually
      READER_IP: "192.168.1.200" # TODO: This has to be set manually
      READER_SUBTYPE: none

  reenvio:
   container_name: monotempo_reenvio
   restart: always
   build:
     context: Reenvio
   depends_on:
     - db
   environment:
     RABBITMQ_HOST: rabbitmq
     RABBITMQ_PORT: 5672
     RABBITMQ_USER: guest
     RABBITMQ_PASS: guest
     MYSQL_DB: mytempo
     MYSQL_HOST: db
     MYSQL_PORT: 3306
     MYSQL_USER: mytempo_user
     MYSQL_PASS: mytempo1
     MYTEMPO_API_URL: "api.v2.mytempo.esp.br"

volumes:
  db_data:
