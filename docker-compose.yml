#version: '3.8'

#   By Rodrigo Monteiro Junior (TsukiGva2)
#   qua 28 ago 2024 12:41:57 -03
#
#      Please ensure *ALL* _services_ contain the property
#      `restart: always`, as they run in an embedded
#      environment we cannot control.
#
#      Another useful convention is naming containers
#      like `monotempo_X` where X is the name of the
#      image being built.
#
#   Version 0.2
#     Docker compose file for setting up
#      - MySql.............................(mysql:8.0)
#      - ...
#      - ...
#      - ...
#      - ...
#      - PÃ¡gina Hotspot....................(php) <-- added
#
#      And PhpMyAdmin for debugging database stuff
#
#
#      Reorganized priorities:
#
#      - TODO: Unhardcode values everywhere, use a .env instead;
#
#     < Low Priority >
#
#      - TODO: bump mysql to latest;
#      - TODO: remove PhpMyAdmin? [Y/n];
#      - TODO: remove rabbitmq-management plugin? [Y/n].
#      - TODO: improve security at mysql and rabbitmq containers;
#
#   Version 0.1
#     Docker compose file for setting up
#      - MySql.............................(mysql:8.0)
#      - Reader............................(MyReader)
#      - RabbitMQ Message broker for comms.(rabbitmq)
#      - Auto-Update functionality.........(Receba)
#      - Sending collected data to the API.(Envio)
#
#      And PhpMyAdmin for debugging database stuff
#
#      - TODO: Unhardcode values everywhere, use a .env instead;
#      - TODO: bump mysql to latest;
#      - TODO: improve security at mysql and rabbitmq containers;
#      - TODO: remove PhpMyAdmin? [Y/n];
#      - TODO: remove rabbitmq-management plugin? [Y/n].
#
#      < Low priority >
#
#      - TODO: Use a script (or just the fucking .env) to set
#              the reader type and model name easily.

services:
  db:
    # TODO: bump mysql to latest?
    image: mysql:8.0
    container_name: monotempo_mysql
    restart: always
    environment:
      # XXX: security? Never heard of it
      MYSQL_ROOT_PASSWORD: mytempo_root1
      MYSQL_DATABASE: mytempo
      MYSQL_USER: mytempo_user
      MYSQL_PASSWORD: mytempo1
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/mytempo.sql:/docker-entrypoint-initdb.d/mytempo.sql
      - ./mysql/my.cnf:/etc/my.cnf
      - db_data:/var/lib/mysql

  # FIXME: remove this, it's just for debugging
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: monotempo_phpmyadmin
    restart: always
    environment:
      PMA_HOST: db
      PMA_USER: mytempo_user
      PMA_PASSWORD: mytempo1
    ports:
      - "8082:80"

  rabbitmq:
    # FIXME: management is also a debug thing, get rid of it
    image: rabbitmq:3-management
    container_name: monotempo_rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      # XXX: less of a security concern, but please set better credentials
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  php:
    container_name: monotempo_pagina
    restart: always
    build:
      context: Php
    depends_on:
      - db
      - rabbitmq
    volumes:
      - ./network:/host-network
    env_file: shared.env
    ports:
      - 80:80

  receba:
    container_name: monotempo_receba
    restart: always
    build:
      context: Receba
    depends_on:
      - db
    env_file: shared.env

  envio:
    container_name: monotempo_envio
    restart: always
    build:
      context: Envio
    depends_on:
      - rabbitmq
      - db
    env_file: shared.env

  process:
    container_name: ProcessAthletes
    restart: always
    build:
      context: Process-Athletes
    depends_on:
      - rabbitmq
      - db
    env_file: shared.env

  aa2:
    container_name: aa2
    restart: always
    privileged: true
    build:
      context: AA2
    depends_on:
      - rabbitmq
      - db
    env_file:
      - AA2/aa2.env
      - shared.env
    volumes:
      - /dev:/dev
      - /etc/localtime:/etc/localtime:ro
      - /tmp:/tmp

  myreader:
    container_name: monotempo_myreader
    restart: always
    build:
      context: MyReader
    logging:
      driver: none
    depends_on:
      - rabbitmq
      - db
    env_file: shared.env

  reenvio:
   container_name: monotempo_reenvio
   restart: always
   build:
     context: Reenvio
   depends_on:
     - db
   env_file: shared.env

volumes:
  db_data:
